{% extends 'app/base.html' %}
{% load static %}

{% block title %}Admin Interface{% endblock %}

{% block extra_css %}
<link href="{% static 'app/css/dashboard.css' %}" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
<style>
    /* Ajout de padding en bas des cellules des jours */
    #calendarDays .day-cell {
        padding-bottom: 60px; /* Ajustez cette valeur selon vos besoins */
    }
    
    /* Si les jours ne sont pas dans des éléments avec la classe day-cell, utilisez ceci */
    #calendarDays > div {
        padding-bottom: 60px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header with navigation buttons -->
<div class="header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Admin Interface</h2>
            <div>
                <a class="btn btn-primary">⚙️ Paramètres</a>
                <a class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#usersModal">👤 Utilisateurs</a>
                <a class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exportModal">📅 Données</a>
                <a class="btn btn-danger">🚪 Déconnexion</a>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Weekly calendar -->
    <div class="calendar mt-4">
        <div class="calendar-header">
            <button id="prevWeek" class="btn btn-sm btn-outline-primary">⬅️</button>
            <h3 id="weekDisplay">Semaine du <span id="weekStart"></span> au <span id="weekEnd"></span></h3>
            <button id="nextWeek" class="btn btn-sm btn-outline-primary">➡️</button>
        </div>
        
        <div class="row" id="calendarDays">
            <!-- Calendar days will be generated by JavaScript -->
        </div>
    </div>
</div>

<!-- Modal for adding reservation -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reservationModalLabel">Ajouter une réservation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="reservationForm">
                    <div class="mb-3">
                        <label for="reservationDate" class="form-label">Date</label>
                        <input type="text" id="reservationDate" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="userDropdown" class="form-label">Utilisateur</label>
                        <select id="userDropdown" class="form-select">
                            <option value="" disabled selected>Choisir un utilisateur</option>
                            {% for user in users %}
                                <option value="{{ user.id }}">{{ user.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" id="validateReservation" class="btn btn-primary">Valider</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for day details -->
<div class="modal fade" id="dayDetailsModal" tabindex="-1" aria-labelledby="dayDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayDetailsModalLabel">Détails du jour</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h2 id="detailDayTitle" class="mb-4 text-center"></h2>
                
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Statistiques</h5>
                            </div>
                            <div class="card-body">
                                <div id="statusStats" class="d-flex justify-content-around flex-wrap">
                                    <!-- Stats will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Liste des personnes</h5>
                            </div>
                            <div class="card-body">
                                <!-- Filtres pour la liste des personnes -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text">Recherche</span>
                                            <input type="text" id="searchPeople" class="form-control" placeholder="Rechercher par nom...">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text">Statut</span>
                                            <select id="statusFilter" class="form-select">
                                                <option value="all">Tous les statuts</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div id="peopleList">
                                    <!-- People list will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for user management -->
<div class="modal fade" id="usersModal" tabindex="-1" aria-labelledby="usersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="usersModalLabel">Gestion des utilisateurs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <input type="text" id="userSearchInput" class="form-control w-50" placeholder="Rechercher un utilisateur...">
                    <button type="button" class="btn btn-success" id="addUserBtn">
                        <i class="bi bi-plus-circle"></i> Ajouter un utilisateur
                    </button>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Nom d'utilisateur</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be loaded here -->
                            <tr>
                                <td colspan="4" class="text-center">Chargement des utilisateurs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="userLoadingError" class="alert alert-danger" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for add/edit user -->
<div class="modal fade" id="userFormModal" tabindex="-1" aria-labelledby="userFormModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userFormModalLabel">Ajouter un utilisateur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId" name="userId">
                    
                    <div class="mb-3">
                        <label for="userName" class="form-label">Nom</label>
                        <input type="text" class="form-control" id="userName" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="userUsername" class="form-label">Nom d'utilisateur</label>
                        <input type="text" class="form-control" id="userUsername" name="username" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="userEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="userEmail" name="email">
                    </div>
                    
                    <div class="mb-3">
                        <label for="userStatus" class="form-label">Status</label>
                        <select class="form-select" id="userStatus" name="status" required>
                            {% for status in statuses %}
                            <option value="{{ status.0 }}">{{ status.0 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3" id="passwordFields">
                        <label for="userPassword" class="form-label">Mot de passe</label>
                        <input type="password" class="form-control" id="userPassword" name="password">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for export reservation data -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">Exporter les données de réservation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Format d'exportation</label>
                        <select id="exportFormat" class="form-select">
                            <option value="" disabled selected>Choisir un format</option>
                            <option value="csv">CSV</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="exportStartDate" class="form-label">Date de début</label>
                            <input type="text" id="exportStartDate" class="form-control" placeholder="JJ/MM/AAAA">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="exportEndDate" class="form-label">Date de fin</label>
                            <input type="text" id="exportEndDate" class="form-control" placeholder="JJ/MM/AAAA">
                        </div>
                    </div>
                </form>

                <!-- New statistics section -->
                <div class="statistics-section mt-4">
                    <h5>Statistiques des réservations</h5>
                    <div id="reservationStats" class="p-3 border rounded">
                        <div class="text-center mb-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p>Chargement des statistiques...</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="exportBtn">Exporter</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for settings -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsModalLabel">Paramètres</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <div class="mb-3">
                        <label for="deadlineTime" class="form-label">Heure limite pour réserver un repas le jour même</label>
                        <input type="time" class="form-control" id="deadlineTime" required>
                        <small class="form-text text-muted">
                            Après cette heure, les utilisateurs ne pourront plus réserver pour le jour même.
                        </small>
                    </div>
                    <div id="settingsSaved" class="alert alert-success" style="display: none;">
                        Paramètres enregistrés avec succès!
                    </div>
                    <div id="settingsError" class="alert alert-danger" style="display: none;">
                        Erreur lors de l'enregistrement des paramètres.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" id="saveSettingsBtn">Enregistrer</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap & Custom JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'app/js/manager_dashboard.js' %}"></script>
{% endblock %}
